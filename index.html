<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AR Multimedia — Grupo Modelo</title>

    <!-- Librerías -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: #000;
        font-family: system-ui, -apple-system, sans-serif;
      }

      #hud {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        padding: 8px 12px;
        display: flex;
        justify-content: center;
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.55), transparent);
        z-index: 5;
      }

      button {
        all: unset;
        background: rgba(255, 255, 255, 0.85);
        color: #111;
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        margin: 0 4px;
      }

      button:active {
        transform: translateY(1px);
      }
    </style>
  </head>

  <body>
    <div id="hud">
      <button id="showImageBtn">Imagen</button>
      <button id="showVideoBtn">Video</button>
      <button id="muteBtn">Silencio</button>
    </div>

    <!-- Escena sin marcador -->
    <a-scene
      embedded
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      <a-entity camera></a-entity>

      <!-- Contenedor principal -->
      <a-entity id="panelRoot" position="0 0 -1.2">
        <a-plane
          id="imagePlane"
          width="0.9"
          height="0.5"
          visible="false"
          position="0 0 0.01"
        ></a-plane>

        <a-plane
          id="videoPlane"
          width="0.9"
          height="0.5"
          visible="false"
          position="0 0 0.01"
        ></a-plane>
      </a-entity>
    </a-scene>

    <!-- Video oculto -->
    <video
      id="incidentVideo"
      playsinline
      webkit-playsinline
      preload="auto"
      style="display: none"
    ></video>

    <script>
      const qs = new URLSearchParams(location.search);
      const machineId = qs.get("machine") || "empaquetadora-01";

      const ui = {
        showImage: document.getElementById("showImageBtn"),
        showVideo: document.getElementById("showVideoBtn"),
        mute: document.getElementById("muteBtn"),
      };

      let incidents = [];
      let muted = true;
      let currentMedia = "image";

      const imagePlane = document.getElementById("imagePlane");
      const videoPlane = document.getElementById("videoPlane");
      const videoEl = document.getElementById("incidentVideo");

      videoEl.addEventListener("loadeddata", () => {
        videoPlane.setAttribute("material", "shader: flat; src: #incidentVideo");
      });

      async function loadData() {
        try {
          const res = await fetch("data/incidents.json", { cache: "no-store" });
          const all = await res.json();
          incidents = (all[machineId] || all["empaquetadora-01"]).incidentes;
          const it = incidents[0];

          if (it.imagen) {
            imagePlane.setAttribute("material", "shader: flat; src: " + it.imagen);
            imagePlane.setAttribute("visible", true);
          }

          if (it.video) {
            videoEl.src = it.video;
            videoEl.muted = muted;
            videoPlane.setAttribute("material", "shader: flat; src: #incidentVideo");
          }
        } catch (e) {
          console.error("Error al cargar datos:", e);
        }
      }

      ui.showImage.onclick = () => {
        imagePlane.setAttribute("visible", true);
        videoPlane.setAttribute("visible", false);
        videoEl.pause();
      };

      ui.showVideo.onclick = () => {
        imagePlane.setAttribute("visible", false);
        videoPlane.setAttribute("visible", true);
        videoEl.play().catch(() => {});
      };

      ui.mute.onclick = () => {
        muted = !muted;
        videoEl.muted = muted;
        ui.mute.textContent = muted ? "Silencio" : "Con sonido";
      };

      loadData();
    </script>
  </body>
</html>
