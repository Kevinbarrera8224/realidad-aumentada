<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Info AR de Incidentes — Grupo Modelo</title>
    <!-- A‑Frame + AR.js (WebAR, sin app) -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
    <style>
      body { margin:0; overflow:hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
      #hud {
        position: fixed; top: 0; left: 0; right: 0; padding: 8px 12px;
        display: flex; gap: 8px; align-items: center; justify-content: space-between;
        background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,0));
        color: white; z-index: 5;
      }
      #hud .pill { padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,.1); backdrop-filter: blur(6px); }
      #controls { display:flex; gap:8px; }
      button {
        all: unset; background: rgba(255,255,255,.85); color:#111; padding:6px 10px; border-radius:10px;
        cursor:pointer; font-weight:600;
      }
      button:active { transform: translateY(1px); }
      #toast {
        position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,.7); color: white; padding: 8px 10px; border-radius: 8px;
        font-size: 14px; z-index:5; display:none;
      }
      .credit { position: fixed; bottom: 6px; right: 10px; color: rgba(255,255,255,.7); font-size: 12px; }
    </style>
  </head>
  <body>
    <div id="hud">
      <div id="machinePill" class="pill">Cargando máquina…</div>
      <div id="controls">
        <button id="prevBtn" title="Incidente anterior">◀</button>
        <button id="nextBtn" title="Siguiente incidente">▶</button>
        <button id="toggleBtn" title="Mostrar/ocultar panel">Ocultar panel</button>
        <button id="muteBtn" title="Silenciar video">Silencio</button>
      </div>
    </div>
    <div id="toast"></div>
    <div class="credit">AR.js • A‑Frame</div>

    <!-- AR scene -->
    <a-scene
      vr-mode-ui="enabled:false"
      embedded
      renderer="logarithmicDepthBuffer: true"
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">
      
      <!-- Cámara -->
      <a-entity camera></a-entity>

      <!-- Marcador: por defecto 'hiro'. Puedes cambiar a barcode o tu propio patrón. -->
      <a-marker type="pattern" url="https://raw.githubusercontent.com/AR-js-org/AR.js/master/three.js/examples/marker-training/examples/pattern-files/pattern-hiro.patt" id="marker">
        <!-- Contenedor de nuestro UI 3D -->
        <a-entity id="panelRoot" position="0 0 0">
          <!-- Panel principal (fondo) -->
          <a-plane id="panelBg" width="1.3" height="0.8" color="#111" opacity="0.8" position="0 0.2 0"></a-plane>
          <!-- Título -->
          <a-entity id="titleText" text="value: Incidente; width: 1.5; color: #FFD54F; anchor: center; baseline: top; wrapCount: 32"
                    position="0 0.52 0.01"></a-entity>
          <!-- Resumen -->
          <a-entity id="summaryText" text="value: ; width: 1.2; color: #FFFFFF; anchor: center; baseline: top; wrapCount: 36"
                    position="0 0.28 0.01"></a-entity>
          <!-- Recomendación -->
          <a-entity id="recoText" text="value: ; width: 1.2; color: #B3E5FC; anchor: center; baseline: top; wrapCount: 36"
                    position="0 0.02 0.01"></a-entity>
          <!-- Video (opcional) -->
          <a-plane id="videoPlane" width="0.6" height="0.34" position="0 -0.33 0.01" visible="false"></a-plane>
        </a-entity>
      </a-marker>

      <a-entity id="noMarkerHint" position="0 1.6 -2" text="value: Apunta al marcador junto a la máquina; width: 2.5; color: #ffffff"></a-entity>

      <a-entity camera></a-entity>
    </a-scene>

    <video id="incidentVideo" playsinline webkit-playsinline preload="metadata" style="display:none"></video>

    <script>
      const qs = new URLSearchParams(location.search);
      const machineId = qs.get("machine") || "empaquetadora-01";

      const ui = {
        pill: document.getElementById("machinePill"),
        toast: document.getElementById("toast"),
        prev: document.getElementById("prevBtn"),
        next: document.getElementById("nextBtn"),
        toggle: document.getElementById("toggleBtn"),
        mute: document.getElementById("muteBtn"),
      };

      function showToast(msg, ms=1500){ ui.toast.textContent = msg; ui.toast.style.display = 'block'; setTimeout(()=>ui.toast.style.display='none', ms); }

      let incidents = [];
      let idx = 0;
      let panelVisible = true;
      let muted = true;

      const marker = document.getElementById('marker');
      const panelRoot = document.getElementById('panelRoot');
      const titleText = document.getElementById('titleText');
      const summaryText = document.getElementById('summaryText');
      const recoText = document.getElementById('recoText');
      const videoPlane = document.getElementById('videoPlane');
      const videoEl = document.getElementById('incidentVideo');

      // Wire video texture when available
      let videoTex;
      videoEl.addEventListener('loadedmetadata', () => {
        const plane = videoPlane;
        plane.setAttribute('material', 'shader: flat; src: #incidentVideo');
      });

      function applyIncident(i){
        const it = incidents[i];
        titleText.setAttribute('text', 'value', `${it.fecha} — ${it.titulo}`);
        summaryText.setAttribute('text', 'value', it.resumen);
        recoText.setAttribute('text', 'value', 'Recomendación: ' + it.recomendacion);

        // Video optional
        if(it.video){
          videoEl.src = it.video;
          videoEl.muted = muted;
          videoEl.currentTime = 0;
          videoEl.play().catch(()=>{});
          videoPlane.setAttribute('visible', true);
        } else {
          videoEl.pause();
          videoPlane.setAttribute('visible', false);
        }

        ui.pill.textContent = `Máquina: ${it.maquina}  •  Incidente ${i+1}/${incidents.length}`;
      }

      async function loadData(){
        try{
          const res = await fetch('data/incidents.json', {cache: 'no-store'});
          const all = await res.json();
          incidents = (all[machineId] || all['empaquetadora-01']).incidentes;
          ui.pill.textContent = `Máquina: ${(all[machineId]||all['empaquetadora-01']).nombre}`;
          applyIncident(0);
        } catch(e){
          console.error(e);
          showToast("No pude cargar los incidentes.");
        }
      }

      // Simple controls
      ui.prev.onclick = () => { idx = (idx - 1 + incidents.length) % incidents.length; applyIncident(idx); };
      ui.next.onclick = () => { idx = (idx + 1) % incidents.length; applyIncident(idx); };
      ui.toggle.onclick = () => {
        panelVisible = !panelVisible;
        panelRoot.setAttribute('visible', panelVisible);
        ui.toggle.textContent = panelVisible ? "Ocultar panel" : "Mostrar panel";
      };
      ui.mute.onclick = () => {
        muted = !muted;
        videoEl.muted = muted;
        ui.mute.textContent = muted ? "Silencio" : "Con sonido";
      };

      // Marker visibility hint
      marker.addEventListener('markerFound', ()=>{
        document.getElementById('noMarkerHint').setAttribute('visible', false);
        showToast('Marcador detectado');
        if(!muted && videoEl.src) videoEl.play().catch(()=>{});
      });
      marker.addEventListener('markerLost', ()=>{
        document.getElementById('noMarkerHint').setAttribute('visible', true);
        if(videoEl.src) videoEl.pause();
      });

      loadData();
    </script>
  </body>
</html>
